<!doctype html>
<html lang="hr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nogomet HNB Savica</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0f1720; --panel:#121a24; --muted:#8aa0b2; --text:#e6eef6; --accent:#3dd6ff;
  --win:#22c55e; --draw:#eab308; --loss:#ef4444; --card:#101823; --chip:#1b2633;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1200px;margin:0 auto;padding:24px}
.header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
.logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#38bdf8,#0ea5e9)}
h1{font-size:20px;margin:0}
.small{font-size:12px;color:#89a1b4}
.grid{display:grid;gap:16px}
@media(min-width:900px){
  .grid-cols-3{grid-template-columns:repeat(3,1fr)}
  .grid-cols-2{grid-template-columns:repeat(2,1fr)}
}
.card{background:var(--panel);border:1px solid #1e2a38;border-radius:14px;padding:16px}
.card h2{font-size:16px;margin:0 0 12px 0;color:#cce1f1}
.kpis{display:grid;gap:12px}
.kpi{background:var(--card);border:1px solid #1e2a38;border-radius:14px;padding:14px}
.kpi .title{color:var(--muted);font-size:12px;margin-bottom:6px}
.kpi .value{font-weight:700;font-size:24px}
.badge{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:#cfe4f3;border:1px solid #223141;border-radius:999px;padding:4px 10px;font-size:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px 8px;border-bottom:1px solid #1f2a36;font-size:14px}
.table th{color:#9fb4c6;text-align:left;font-weight:600}
.form-strip{display:flex;gap:6px}
.form-dot{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#0b1220}
.form-dot.win{background:var(--win)}
.form-dot.draw{background:var(--draw)}
.form-dot.loss{background:var(--loss)}
.list{display:flex;flex-direction:column;gap:10px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.btn{background:#1a2430;border:1px solid #273447;color:#d6e6f5;border-radius:10px;padding:8px 12px;font-size:13px;cursor:pointer}
.btn:hover{filter:brightness(1.1)}
.pill{display:inline-flex;gap:8px;align-items:center;background:#0f1924;border:1px solid #213042;border-radius:14px;padding:6px 10px}
.pill strong{font-weight:700}
.section{display:grid;gap:16px}
@media(min-width:900px){ .section{grid-template-columns: 1fr 1fr} }
</style>

</head>
<body>

<div class="container">

  <div class="header">
    <div class="logo"></div>
    <div>
      <h1>Nogomet HNB Savica</h1>
      <div class="small" id="updated"></div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid grid-cols-3 kpis">
    <div class="kpi">
      <div class="title">Ukupno u blagajni (sezona)</div>
      <div class="value" id="kpi-kitty">0.00 €</div>
      <div class="small" id="season"></div>
    </div>
    <div class="kpi">
      <div class="title">Termini (kumulativ)</div>
      <div class="value" id="kpi-terms">0/0</div>
      <div class="small">Odigrano / mogućih petaka</div>
    </div>
    <div class="kpi">
      <div class="title">Ishod (sezona)</div>
      <div id="kpi-outcomes" class="list"></div>
    </div>
  </div>

  <!-- Forma i Streakovi -->
  <div class="section" style="margin-top:16px">
    <div class="card">
      <h2>Najbolja forma (Top 5)</h2>
      <div id="topForm" class="list"></div>
    </div>
    <div class="card">
      <h2>Streakovi (Top 5)</h2>
      <div class="row">
        <span class="badge">W-streak</span>
        <div id="streakWins" class="row"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="badge">L-streak</span>
        <div id="streakLosses" class="row"></div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-2" style="margin-top:16px">
    <div class="card">
      <h2>Dolaznost po igračima (Top 10)</h2>
      <canvas id="chartAttendance" height="120"></canvas>
    </div>
    <div class="card">
      <h2>Pobjede / Porazi (Top 10)</h2>
      <canvas id="chartWL" height="120"></canvas>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Master tablica</h2>
    <table class="table" id="tblPlayers">
      <thead>
        <tr>
          <th>Igrač</th><th>Utakmice</th><th>W</th><th>D</th><th>L</th><th>Bodovi</th><th>Dolaznost</th><th>Uplate (€)</th><th>Forma</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Mjesečni obračuni</h2>
    <div id="months" class="list"></div>
  </div>

</div>

<script>
// ⬇️ zamijeni ako si deployao novi web app
const API = "https://script.google.com/macros/s/AKfycbxOvVJpNioiQ5BAwdry5wRrcLffiVkyXztSYTa4wE8BNQ65lgiI1nt5RzKoDYIRfyVMFw/exec";

let DATA = null;

(async function init(){
  const res = await fetch(API);
  DATA = await res.json();

  document.getElementById('updated').textContent =
    "Ažurirano: " + new Date(DATA.generatedAt).toLocaleString("hr-HR");

  // A-varijanta: backend šalje broj godine
  document.getElementById('season').textContent = "Godina " + DATA.season;

  document.getElementById('kpi-kitty').textContent = euro(DATA.kitty);

  document.getElementById('kpi-terms').textContent =
    DATA.seasonTotals.matchesPlayed + "/" + DATA.seasonTotals.fridays;

  renderOutcomes(DATA.seasonTotals);

  renderTopForm(DATA.players);
  renderStreaks(DATA.players);

  renderAttendanceChart(DATA.players);
  renderWLChart(DATA.players);

  renderPlayersTable(DATA.players);
  renderMonths(DATA.months);
})();

function euro(x){ return (Number(x)||0).toFixed(2) + " €"; }

function renderOutcomes(t){
  document.getElementById('kpi-outcomes').innerHTML = `
    <span class="badge">Crni pobjede: ${t.blackWins}</span>
    <span class="badge">Bijeli pobjede: ${t.whiteWins}</span>
    <span class="badge">Neriješeno: ${t.draws}</span>
  `;
}

// Najbolja forma (Top 5) — W=3, D=1, L=0; tiebreak: više W, manje L, pa bodovi
function renderTopForm(players){
  const score = f => f.reduce((s,ch)=> s + (ch==='W'?3:ch==='D'?1:0), 0);
  const top = [...players]
    .map(p => ({...p, formScore: score(p.form||[]) }))
    .sort((a,b)=>{
      if (b.formScore !== a.formScore) return b.formScore - a.formScore;
      if (b.wins !== a.wins) return b.wins - a.wins;
      if (a.losses !== b.losses) return a.losses - b.losses;
      return b.points - a.points;
    })
    .slice(0,5);

  const wrap = document.getElementById('topForm');
  wrap.innerHTML = '';
  top.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'pill';
    el.innerHTML = `<strong>${p.name}</strong> — forma: ${p.form.join(' ')} &nbsp;|&nbsp; score ${p.formScore}`;
    wrap.appendChild(el);
  });
}

// Streakovi (Top 5) — trenutni nizovi iz backenda: winStreak, lossStreak
function renderStreaks(players){
  const wins = [...players].filter(p=>p.winStreak>0).sort((a,b)=> b.winStreak - a.winStreak).slice(0,5);
  const losses = [...players].filter(p=>p.lossStreak>0).sort((a,b)=> b.lossStreak - a.lossStreak).slice(0,5);

  const w = document.getElementById('streakWins');  w.innerHTML = '';
  const l = document.getElementById('streakLosses'); l.innerHTML = '';

  wins.forEach(p=>{
    const el = document.createElement('span');
    el.className = 'badge';
    el.textContent = `${p.name}: ${p.winStreak}`;
    w.appendChild(el);
  });
  losses.forEach(p=>{
    const el = document.createElement('span');
    el.className = 'badge';
    el.textContent = `${p.name}: ${p.lossStreak}`;
    l.appendChild(el);
  });
}

function renderPlayersTable(players){
  players = [...players].sort((a,b)=> b.points - a.points);
  const tb = document.querySelector("#tblPlayers tbody");
  tb.innerHTML = "";
  players.forEach(p=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${p.played}</td>
      <td>${p.wins}</td>
      <td>${p.draws}</td>
      <td>${p.losses}</td>
      <td>${p.points}</td>
      <td>${(p.attendancePct||0).toFixed(1)}%</td>
      <td>${euro(p.amountTotal)}</td>
      <td>${renderForm(p.form||[])}</td>
    `;
    tb.appendChild(tr);
  });
}

function renderForm(list){
  return `<div class="form-strip">` +
    list.map(ch=>{
      const cls = ch==="W"?"win":(ch==="D"?"draw":"loss");
      return `<div class="form-dot ${cls}">${ch}</div>`;
    }).join("") +
    `</div>`;
}

function renderMonths(months){
  const wrap = document.getElementById("months");
  wrap.innerHTML="";
  months.forEach(m=>{
    const div=document.createElement("div");
    div.className="kpi";
    div.innerHTML=`
      <div class="title">${m.month}</div>
      <div class="value">${m.matchesPlayed}/${m.fridays} termina</div>
      <div class="badge">U blagajni: ${euro(m.kitty)}</div>
      <div class="badge">Top 3: ${m.top3.map(x=>x.name+" ("+x.points+")").join(", ")}</div>
    `;
    wrap.appendChild(div);
  });
}

function renderAttendanceChart(players){
  const top = [...players].sort((a,b)=> b.attendancePct - a.attendancePct).slice(0,10);
  new Chart(document.getElementById("chartAttendance"),{
    type:"bar",
    data:{ labels: top.map(x=>x.name),
      datasets:[{label:"Dolaznost %",data:top.map(x=>x.attendancePct)}] },
    options:{scales:{y:{beginAtZero:true,max:100}},plugins:{legend:{display:false}}}
  });
}

function renderWLChart(players){
  const top = [...players].sort((a,b)=> b.wins - a.wins).slice(0,10);
  new Chart(document.getElementById("chartWL"),{
    type:"bar",
    data:{
      labels: top.map(x=>x.name),
      datasets:[
        {label:"Pobjede", data:top.map(x=>x.wins)},
        {label:"Porazi", data:top.map(x=>x.losses)}
      ]
    }
  });
}
</script>

</body>
</html>
