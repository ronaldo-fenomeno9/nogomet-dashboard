<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Nogomet – Dashboard</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:#0b0f14;color:#e6e9ef}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:800px){.grid-3{grid-template-columns:repeat(3,1fr)} .grid-2{grid-template-columns:repeat(2,1fr)}}
    .card{background:#11161d;border:1px solid #1e2733;border-radius:14px;padding:16px}
    .title{font-size:20px;font-weight:700;margin:0 0 8px}
    .muted{color:#9aa7b5;font-size:13px}
    .big{font-size:28px;font-weight:800}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1e2733;text-align:left;font-size:14px}
    th{color:#9aa7b5;font-weight:600}
    .pill{background:#0f1720;border:1px solid #203142;border-radius:999px;padding:4px 10px;font-size:12px;color:#9bc1ff}
    .ok{color:#8fffba}.bad{color:#ff9b9b}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    /* timeline */
    .timeline{position:relative;margin-left:8px}
    .timeline:before{content:"";position:absolute;left:10px;top:0;bottom:0;width:2px;background:#1e2733;border-radius:2px}
    .t-item{position:relative;padding:10px 12px 10px 30px;margin:8px 0;border:1px solid #1e2733;background:#0f141b;border-radius:12px}
    .t-item:before{content:"";position:absolute;left:4px;top:16px;width:12px;height:12px;border-radius:50%;background:#2b3a4d;border:2px solid #89a7ff}
    .tag{display:inline-block;border:1px solid #2a3647;background:#0f1720;border-radius:8px;padding:2px 8px;margin-right:6px;font-size:12px;color:#a9c1ff}
    .tag.link{cursor:pointer;text-decoration:underline}
    .winner{display:inline-block;border:1px solid #2d4a2d;background:#0e1710;color:#8fffba;border-radius:8px;padding:2px 8px;font-size:12px}
    .draw{display:inline-block;border:1px solid #49492d;background:#16170e;color:#ffe08a;border-radius:8px;padding:2px 8px;font-size:12px}

    .list{display:grid;gap:10px}
    .match{border:1px solid #1e2733;background:#0f141b;border-radius:12px;padding:12px}
    .teams{display:grid;gap:8px}
    @media(min-width:700px){.teams{grid-template-columns:1fr 1fr}}
    .flex{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

    /* sort + filter + modal */
    th.sortable { cursor:pointer; }
    th.sortable:hover { color:#fff; }
    th.sorted-asc::after { content:" ↑"; font-size:12px; }
    th.sorted-desc::after { content:" ↓"; font-size:12px; }

    #playerFilter {
      width:100%; padding:6px 10px; margin-bottom:12px;
      border-radius:8px; border:1px solid #1e2733;
      background:#0f141b; color:#e6e9ef; font-size:14px;
    }

    .modal-back { position:fixed; inset:0; background:rgba(0,0,0,.7); display:flex; align-items:center; justify-content:center; z-index:10000; }
    .modal { background:#11161d; border-radius:14px; padding:20px; max-width:560px; width:92%; border:1px solid #1e2733; }
    .modal h3 { margin-top:0; }
    .close-btn{padding:6px 14px;background:#1e2733;color:#fff;border:0;border-radius:8px;cursor:pointer}
    .list-players{display:grid;gap:8px;margin-top:8px}
    .player-pill{border:1px solid #2a3647;background:#0f1720;border-radius:10px;padding:6px 10px;display:flex;justify-content:space-between;align-items:center}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Head cards -->
  <div class="grid grid-3">
    <div class="card">
      <div class="title">Ukupno u blagajni (sezona)</div>
      <div id="kitty" class="big">–</div>
      <div id="seasonMeta" class="muted"></div>
    </div>
    <div class="card">
      <div class="title">Termini</div>
      <div class="row">
        <div>
          <div class="muted">Ovaj mjesec</div>
          <div class="big"><span id="playedMonth">–</span>/<span id="fridaysMonth">–</span></div>
        </div>
        <div>
          <div class="muted">Sezona</div>
          <div class="big"><span id="playedSeason">–</span>/<span id="fridaysSeason">–</span></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="title">Ishod (sezona)</div>
      <div class="row"><span>Crni pobjede</span><span id="blackWins" class="pill">–</span></div>
      <div class="row"><span>Bijeli pobjede</span><span id="whiteWins" class="pill">–</span></div>
      <div class="row"><span>Neriješeno</span><span id="draws" class="pill">–</span></div>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-2" style="margin-top:16px">
    <div class="card">
      <div class="title">Dolaznost po igračima (Top 12)</div>
      <canvas id="attChart" height="160"></canvas>
    </div>
    <div class="card">
      <div class="title">Pobjede / Porazi (Top 10)</div>
      <canvas id="wlChart" height="160"></canvas>
    </div>
  </div>

  <!-- Players table -->
  <div class="card" style="margin-top:16px">
    <div class="row">
      <div class="title" style="margin:0">Master tablica</div>
      <span id="updated" class="muted"></span>
    </div>

    <input id="playerFilter" type="text" placeholder="Pretraži igrače…">

    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>Igrač</th><th>Utakmice</th><th>W</th><th>D</th><th>L</th>
            <th>Bodovi</th><th>Dolaznost</th><th>Uplata (I)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Months timeline -->
  <div class="card" style="margin-top:16px">
    <div class="title">Mjesečni obračuni</div>
    <div id="months" class="timeline"></div>
  </div>

  <!-- Matches list -->
  <div class="card" style="margin-top:16px">
    <div class="title">Utakmice (trenutni mjesec)</div>
    <div id="matches" class="list"></div>
  </div>

</div>

<script>
const DATA_URL = "https://raw.githubusercontent.com/ronaldo-fenomeno9/nogomet-dashboard/main/data/data.json";

// helpers
const norm = s => (s||"")
  .toString()
  .normalize("NFD")
  .replace(/[\u0300-\u036f]/g,"")   // skini dijakritiku
  .replace(/[^\w\s\-]/g,"")         // makni čudne znakove
  .replace(/\s+/g," ")
  .trim()
  .toLowerCase();

function euro(val){ return (val??0).toFixed(2)+' €'; }
function td(val){ return (val??0); }
function tdPct(val){ return (val??0).toFixed(1)+'%'; }
function mmName(ym){ if(!ym) return "-"; const [y,m]=ym.split("-"); return `${m}/${y}`; }

// izračun penaliziranih za mjesec (attendance < 50%)
function penalizedForMonth(ym, matches, allPlayers){
  const monthMatches = matches.filter(m => (m.date||"").slice(0,7) === ym);
  const total = monthMatches.length;
  if (total === 0) return [];

  const played = new Map();
  monthMatches.forEach(mt=>{
    const all = (mt.black||[]).concat(mt.white||[]);
    all.forEach(nm=>{
      const k = norm(nm);
      played.set(k, (played.get(k)||0)+1);
    });
  });

  const out = [];
  const baseline = allPlayers.length ? allPlayers : Array.from(played.keys()); // fallback

  baseline.forEach(n=>{
    const key = typeof n === "string" ? norm(n) : n;
    const display = typeof n === "string" ? n : n; // već su imena
    const count = played.get(key) || 0;
    const att = count/total;
    if (att < 0.5) out.push(display);
  });

  // sortiraj
  return out.sort((a,b)=> a.localeCompare(b,'hr',{sensitivity:'base'}));
}

// modal util
function showModal(title, bodyHtml){
  const back = document.createElement("div");
  back.className = "modal-back";
  back.innerHTML = `
    <div class="modal">
      <h3>${title}</h3>
      <div>${bodyHtml}</div>
      <div style="text-align:right;margin-top:14px">
        <button class="close-btn">Zatvori</button>
      </div>
    </div>
  `;
  document.body.appendChild(back);
  back.querySelector(".close-btn").onclick = ()=> back.remove();
  back.onclick = (e)=>{ if(e.target===back) back.remove(); };
}

// sortable
let sortState = { col:null, dir:1 };
function makeTableSortable() {
  const ths = document.querySelectorAll("#tbl th");
  ths.forEach((th, idx)=>{
    th.classList.add("sortable");
    th.onclick = ()=> sortTable(idx, th);
  });
}
function sortTable(colIndex, thEl) {
  const tbody = document.querySelector("#tbl tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  document.querySelectorAll("th").forEach(th=> th.classList.remove("sorted-asc","sorted-desc"));
  if (sortState.col === colIndex) sortState.dir *= -1;
  else { sortState.col = colIndex; sortState.dir = 1; }
  const dir = sortState.dir;

  rows.sort((a,b)=>{
    const A = a.children[colIndex].innerText.toLowerCase();
    const B = b.children[colIndex].innerText.toLowerCase();
    const nA = parseFloat(A.replace(",","."));
    const nB = parseFloat(B.replace(",","."));
    if (!isNaN(nA) && !isNaN(nB)) return (nA - nB) * dir;
    return A.localeCompare(B) * dir;
  });
  rows.forEach(r=> tbody.appendChild(r));
  thEl.classList.add(dir===1 ? "sorted-asc" : "sorted-desc");
}

// filter
function enablePlayerFilter() {
  const input = document.getElementById("playerFilter");
  input.oninput = ()=>{
    const q = input.value.toLowerCase();
    document.querySelectorAll("#tbl tbody tr").forEach(tr=>{
      const name = tr.children[0].innerText.toLowerCase();
      tr.style.display = name.includes(q) ? "" : "none";
    });
  };
}

// glavno učitavanje
async function loadData(){
  const res = await fetch(DATA_URL + "?t=" + Date.now());
  const data = await res.json();

  const matchesAll = Array.isArray(data.matches) ? data.matches : [];
  const months = Array.isArray(data.months) ? data.months : [];
  const players = Array.isArray(data.players) ? data.players : [];

  // currentMonth
  let currentMonth = data.currentMonth;
  if (!currentMonth || !/^\d{4}-\d{2}$/.test(currentMonth)) {
    if (months.length) currentMonth = months[months.length - 1].month;
    else if (matchesAll.length) currentMonth = (matchesAll[matchesAll.length - 1].date || "").slice(0,7);
  }

  // sezona – izračun iz matches
  const seasonPlayed = matchesAll.length;
  const seasonFridays = months.reduce((a,m)=>a+(m.fridays||0),0);
  const seasonCount = matchesAll.reduce((acc,m)=>{
    const w = (m.winner||"").toLowerCase();
    if (w==="crni") acc.black++;
    else if (w==="bijeli") acc.white++;
    else acc.draw++;
    return acc;
  },{black:0,white:0,draw:0});

  // head
  // kitty: ako postoji data.kitty koristi; ako nema – zbroji iz mjeseci
  const kitty = (typeof data.kitty === "number")
    ? data.kitty
    : months.reduce((a,m)=>a+(m.kitty||0),0);

  document.getElementById('kitty').textContent = euro(kitty);
  document.getElementById('seasonMeta').textContent =
    `Sezona: ${data.season || "-"} • Ažurirano: ${data.generatedAt || ""}`;

  document.getElementById('playedSeason').textContent  = seasonPlayed;
  document.getElementById('fridaysSeason').textContent = seasonFridays;
  document.getElementById('blackWins').textContent     = seasonCount.black;
  document.getElementById('whiteWins').textContent     = seasonCount.white;
  document.getElementById('draws').textContent         = seasonCount.draw;

  const mRec = months.find(m => m.month === currentMonth) || {};
  document.getElementById('playedMonth').textContent  = td(mRec.matchesPlayed);
  document.getElementById('fridaysMonth').textContent = td(mRec.fridays);
  document.getElementById('updated').textContent      = "Ažurirano: " + (data.generatedAt || "");

  // table
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  players.forEach(p=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="player-name">${p.name}</td>
      <td>${td(p.played)}</td>
      <td>${td(p.wins)}</td>
      <td>${td(p.draws)}</td>
      <td>${td(p.losses)}</td>
      <td>${td(p.points)}</td>
      <td>${tdPct(p.attendancePct)}</td>
      <td>${euro(p.amountTotal)}</td>
    `;
    tb.appendChild(tr);
  });

  // months timeline + klik na penalizirane
  const monthsWrap = document.getElementById('months');
  monthsWrap.innerHTML = "";
  months.slice().sort((a,b)=> (a.month>b.month?1:-1)).forEach(m=>{
    const div = document.createElement("div");
    div.className = "t-item";

    // izračun penaliziranih na licu mjesta
    const penalNames = penalizedForMonth(m.month, matchesAll, players.map(p=>p.name));
    const penalCount = penalNames.length;

    const tags = `
      <span class="tag">${td(m.matchesPlayed)}/${td(m.fridays)} termina</span>
      <span class="tag">Crni ${td(m.blackWins)}</span>
      <span class="tag">Bijeli ${td(m.whiteWins)}</span>
      <span class="tag">Neriješeno ${td(m.draws)}</span>
      <span class="tag link" data-month="${m.month}" data-penals="${encodeURIComponent(JSON.stringify(penalNames))}">
        Penalizirani: ${penalCount}
      </span>
    `;
    div.innerHTML = `
      <div class="row" style="gap:8px">
        <div class="title" style="margin:0">${mmName(m.month)}</div>
        <div class="big">${euro(m.kitty)}</div>
      </div>
      <div class="flex" style="margin-top:6px">${tags}</div>
    `;
    monthsWrap.appendChild(div);
  });

  // click handler za penalizirane
  monthsWrap.addEventListener("click", (e)=>{
    const t = e.target.closest(".tag.link");
    if (!t) return;
    const ym = t.getAttribute("data-month");
    const names = JSON.parse(decodeURIComponent(t.getAttribute("data-penals")||"[]"));
    const list = names.length
      ? `<div class="list-players">${names.map(n=>`<div class="player-pill"><span>${n}</span><span class="muted">dolaznost < 50%</span></div>`).join("")}</div>`
      : `<div class="muted">Nema penaliziranih igrača za ovaj mjesec.</div>`;
    showModal(`Penalizirani igrači – ${mmName(ym)}`, list);
  });

  // charts
  const topAtt = [...players].sort((a,b)=>(b.attendancePct||0)-(a.attendancePct||0)).slice(0,12);
  new Chart(document.getElementById('attChart'), {
    type:'bar',
    data:{ labels: topAtt.map(p=>p.name),
      datasets:[{ label:'Dolaznost %', data: topAtt.map(p=>+(p.attendancePct||0).toFixed(1)) }]},
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,max:100}}}
  });

  const wlTop = [...players].sort((a,b)=>(b.wins||0)-(a.wins||0)).slice(0,10);
  new Chart(document.getElementById('wlChart'), {
    type:'bar',
    data:{ labels: wlTop.map(p=>p.name),
      datasets:[
        { label:'W', data: wlTop.map(p=>p.wins||0) },
        { label:'L', data: wlTop.map(p=>p.losses||0) }
      ]},
    options:{ responsive:true, scales:{y:{beginAtZero:true}} }
  });

  // matches – samo currentMonth
  const matchesWrap = document.getElementById('matches');
  matchesWrap.innerHTML = "";
  const monthMatches = matchesAll.filter(mt => (mt.date||"").slice(0,7) === currentMonth);
  monthMatches.forEach(mt=>{
    const win = (mt.winner||"").toLowerCase();
    const badge = win==="crni" ? `<span class="winner">Pobjednik: Crni</span>` :
                  win==="bijeli" ? `<span class="winner">Pobjednik: Bijeli</span>` :
                  `<span class="draw">Neriješeno</span>`;
    const div = document.createElement("div");
    div.className = "match";
    div.innerHTML = `
      <div class="row"><div class="muted">${mt.date || "-"}</div><div class="mono">${mt.score || "-"}</div></div>
      <div class="teams" style="margin-top:8px">
        <div><div class="muted">Crni</div><div>${(mt.black||[]).join(", ")}</div></div>
        <div><div class="muted">Bijeli</div><div>${(mt.white||[]).join(", ")}</div></div>
      </div>
      <div style="margin-top:8px">${badge}</div>
    `;
    matchesWrap.appendChild(div);
  });

  // UX
  makeTableSortable();
  enablePlayerFilter();
}

loadData().catch(err=>{
  console.error(err);
  alert("Neuspješno učitavanje podataka. Probaj osvježiti stranicu.");
});
</script>
</body>
</html>
