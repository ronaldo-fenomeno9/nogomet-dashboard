<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>nogomet HNB Savica — Dashboard</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:#0b0f14;color:#e6e9ef}
    a{color:#a9c6ff;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{font-weight:800;font-size:20px;letter-spacing:.3px}
    .muted{color:#9aa7b5}
    .grid{display:grid;gap:16px}
    @media(min-width:860px){.grid-3{grid-template-columns:repeat(3,1fr)} .grid-2{grid-template-columns:repeat(2,1fr)}}
    .card{background:#0f141c;border:1px solid #1c2734;border-radius:14px;padding:16px}
    .title{font-size:18px;font-weight:700;margin:0 0 8px}
    .big{font-size:28px;font-weight:800}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid #1c2734;text-align:left;font-size:14px}
    th{color:#a7b1bd;font-weight:600}
    .pill{border:1px solid #243449;background:#121a25;border-radius:999px;padding:4px 10px;font-size:12px}
    .pill.ok{color:#8fffba;border-color:#2c5344}
    .pill.warn{color:#ffd599;border-color:#5b4a26}
    .pill.bad{color:#ff9b9b;border-color:#5b3030}
    .badge{display:inline-block;border-radius:6px;padding:2px 8px;font-size:12px;font-weight:600}
    .b-win{background:#11301f;color:#86ffba;border:1px solid #1f5033}
    .b-draw{background:#282c36;color:#cfe1ff;border:1px solid #3c4a62}
    .b-loss{background:#341a1a;color:#ffb1b1;border:1px solid #5a2d2d}
    .search{width:100%;padding:10px;border-radius:10px;border:1px solid #1c2734;background:#0b1118;color:#e6e9ef}
    .kicker{font-size:12px;color:#8fa0b3;margin-left:8px}
    .chip{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #263245;background:#101823;color:#cfe1ff;font-size:12px;margin-right:6px}
    .month-card{cursor:pointer}
    .month-details{display:none;margin-top:12px}
    .match{display:flex;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed #1e2b3a}
    .team{font-size:12px;color:#9fb0c3}
    .score{font-weight:800}
    .form-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
    .dot-w{background:#86ffba}.dot-d{background:#cfe1ff}.dot-l{background:#ff9b9b}
    .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;padding:16px}
    .modal .content{max-width:720px;width:100%;background:#0f141c;border:1px solid #1c2734;border-radius:12px;padding:16px}
    .close{float:right;cursor:pointer;font-weight:700;color:#9aa7b5}
    .subtitle{color:#9aa7b5;font-size:13px;margin:2px 0 12px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">nogomet HNB Savica</div>
    <div class="muted">live dashboard</div>
  </header>

  <!-- HEAD CARDS -->
  <div class="grid grid-3">
    <div class="card">
      <div class="title">Ukupno u blagajni</div>
      <div id="kitty" class="big">–</div>
      <div id="updated" class="muted"></div>
    </div>
    <div class="card">
      <div class="title">Termini (kumulativ)</div>
      <div class="big"><span id="played">–</span>/<span id="fridays">–</span></div>
      <div class="muted">Odigrano / mogućih petaka</div>
    </div>
    <div class="card">
      <div class="title">Ishodi (kumulativ)</div>
      <div class="row"><span>Crni pobjede</span><span id="bw" class="pill ok">–</span></div>
      <div class="row"><span>Bijeli pobjede</span><span id="ww" class="pill warn">–</span></div>
      <div class="row"><span>Neriješeno</span><span id="dr" class="pill">–</span></div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="grid grid-2" style="margin-top:16px">
    <div class="card">
      <div class="title">Dolaznost – Top 10</div>
      <canvas id="attChart" height="170"></canvas>
    </div>
    <div class="card">
      <div class="title">Pobjede / Porazi – Top 10</div>
      <canvas id="wlChart" height="170"></canvas>
    </div>
  </div>

  <!-- MASTER + SEARCH -->
  <div class="card" style="margin-top:16px">
    <div class="row" style="margin-bottom:8px">
      <div class="title" style="margin:0">Pregled po igračima</div>
      <input id="q" class="search" placeholder="Pretraži igrača..." />
    </div>
    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>Igrač</th>
            <th>Utakmice</th>
            <th>W</th>
            <th>D</th>
            <th>L</th>
            <th>Bodovi</th>
            <th>Dolaznost</th>
            <th>Forma (posl. 5)</th>
            <th>Uplata (€)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- MJESEČNI OBRAČUNI -->
  <div class="card" style="margin-top:16px">
    <div class="title">Mjesečni obračuni</div>
    <div id="months" class="grid"></div>
  </div>

  <!-- PLAYER MODAL -->
  <div id="playerModal" class="modal" role="dialog" aria-modal="true">
    <div class="content">
      <span class="close" onclick="hideModal()">✕</span>
      <div id="playerName" class="title" style="margin-top:0"></div>
      <div id="playerSub" class="subtitle"></div>
      <div id="playerStats"></div>
    </div>
  </div>
</div>

<script>
const DATA_URL = "./data/data.json"; // GitHub Pages path (relative)

function asciiFold(str="") {
  // zamjena dijakritike za stabilno pretraživanje / prikaz (ako treba)
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
           .replaceAll("đ","d").replaceAll("Đ","D")
           .replaceAll("č","c").replaceAll("Č","C")
           .replaceAll("ć","c").replaceAll("Ć","C")
           .replaceAll("š","s").replaceAll("Š","S")
           .replaceAll("ž","z").replaceAll("Ž","Z");
}

async function loadData(){
  const res = await fetch(DATA_URL + "?v=" + Date.now(), {cache:"no-store"});
  const data = await res.json();

  // shape očekivan iz VBA (Opcija A):
  // {
  //   season: "2025/26",
  //   generatedAt: "2025-10-31T09:10:00Z",
  //   kitty: 123.45,
  //   players: [{name, played, wins, draws, losses, points?, amountTotal}],
  //   matches: [{date:"YYYY-MM-DD", black:[...], white:[...], score:"x:y", winner:"Crni|Bijeli|Neriješeno"}],
  //   months: [
  //     {
  //       month:"YYYY-MM",
  //       matchesPlayed: n, fridays: n, kitty: number,
  //       blackWins:n, whiteWins:n, draws:n,
  //       players:[{name, wins, draws, losses, points, amount}],
  //       matches:[...] // kao gore, ali za taj mjesec
  //     }, ...
  //   ]
  // }

  // HEAD
  document.getElementById('kitty').textContent = ((data.kitty ?? 0).toFixed(2)) + " €";
  document.getElementById('updated').textContent = "Ažurirano: " + (data.generatedAt || "");

  // kumulativ termini i ishodi
  const months = Array.isArray(data.months) ? data.months : [];
  const playedTotal = months.reduce((s,m)=>s+(m.matchesPlayed||0), 0) || (data.matches?.length||0);
  const fridaysTotal = months.reduce((s,m)=>s+(m.fridays||0), 0);
  const bwTotal = months.reduce((s,m)=>s+(m.blackWins||0),0) || countByOutcome(data.matches||[],"Crni");
  const wwTotal = months.reduce((s,m)=>s+(m.whiteWins||0),0) || countByOutcome(data.matches||[],"Bijeli");
  const drTotal = months.reduce((s,m)=>s+(m.draws||0),0) || countByOutcome(data.matches||[],"Neriješeno");

  document.getElementById('played').textContent = playedTotal;
  document.getElementById('fridays').textContent = fridaysTotal;
  document.getElementById('bw').textContent = bwTotal;
  document.getElementById('ww').textContent = wwTotal;
  document.getElementById('dr').textContent = drTotal;

  // MASTER TABLICA + FORMA
  const players = (data.players||[]).map(p=>{
    const pts = (p.points!=null) ? p.points : ((p.wins||0)*3 + (p.draws||0)*1);
    const form = buildFormForPlayer(p.name, data.matches||[], 5);
    const attPct = playedTotal>0 ? ((p.played||0)/playedTotal*100) : 0; // sezonska dolaznost
    return {...p, points:pts, form, attPct};
  }).sort((a,b)=>asciiFold(a.name).localeCompare(asciiFold(b.name)));

  renderPlayersTable(players);

  // CHARTS
  renderAttendanceChart(players);
  renderWLChart(players);

  // MJESEČNI OBRAČUNI
  renderMonths(months, players);
}

function countByOutcome(matches, target){
  return (matches||[]).reduce((s,m)=>s + ((m.winner||"").toLowerCase() === target.toLowerCase() ? 1 : 0), 0);
}

function buildFormForPlayer(playerName, matches, lastN){
  // vrati niz od zadnjih N rezultata: 'W' | 'D' | 'L'
  const name = playerName?.trim()||"";
  const hist = [];
  const sorted = [...(matches||[])].sort((a,b)=>(a.date||"").localeCompare(b.date||""));
  for (const m of sorted) {
    const inBlack = (m.black||[]).some(n=> normalize(n) === normalize(name));
    const inWhite = (m.white||[]).some(n=> normalize(n) === normalize(name));
    if (!inBlack && !inWhite) continue;

    const w = (m.winner||"").toLowerCase();
    if (w === "neriješeno") hist.push("D");
    else if (w === "crni")  hist.push(inBlack ? "W":"L");
    else if (w === "bijeli")hist.push(inWhite ? "W":"L");
  }
  return hist.slice(-lastN);
}

function normalize(s){ return asciiFold(String(s||"").trim().toLowerCase()); }

function renderPlayersTable(players){
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  for (const p of players){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><a href="#" onclick="showPlayer('${encodeURIComponent(p.name)}');return false;">${p.name}</a></td>
      <td>${p.played ?? 0}</td>
      <td>${p.wins ?? 0}</td>
      <td>${p.draws ?? 0}</td>
      <td>${p.losses ?? 0}</td>
      <td>${p.points ?? 0}</td>
      <td>${(p.attPct||0).toFixed(1)}%</td>
      <td>${renderFormDots(p.form)}</td>
      <td>${(p.amountTotal??0).toFixed(2)}</td>
    `;
    tb.appendChild(tr);
  }

  // search
  document.getElementById('q').oninput = (e)=>{
    const q = normalize(e.target.value);
    for (const row of tb.querySelectorAll("tr")){
      const name = normalize(row.cells[0].innerText);
      row.style.display = name.includes(q) ? "" : "none";
    }
  };
}

function renderFormDots(arr){
  const parts = arr.map(v=>{
    if (v==="W") return `<span class="form-dot dot-w" title="W"></span>`;
    if (v==="D") return `<span class="form-dot dot-d" title="D"></span>`;
    return `<span class="form-dot dot-l" title="L"></span>`;
  });
  return parts.join("");
}

function renderAttendanceChart(players){
  const top = [...players].sort((a,b)=>(b.attPct||0)-(a.attPct||0)).slice(0,10);
  const el = document.getElementById('attChart');
  new Chart(el, {
    type:'bar',
    data:{ labels: top.map(p=>p.name),
      datasets:[{ label:'Dolaznost %', data: top.map(p=>+(p.attPct||0).toFixed(1)) }]},
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,max:100}}}
  });
}

function renderWLChart(players){
  const top = [...players].sort((a,b)=>(b.wins||0)-(a.wins||0)).slice(0,10);
  const el = document.getElementById('wlChart');
  new Chart(el, {
    type:'bar',
    data:{ labels: top.map(p=>p.name),
      datasets:[
        { label:'W', data: top.map(p=>p.wins||0) },
        { label:'L', data: top.map(p=>p.losses||0) }
      ]},
    options:{ responsive:true, scales:{y:{beginAtZero:true}} }
  });
}

function renderMonths(months, playersSeason){
  const host = document.getElementById('months');
  host.innerHTML = "";

  // posloži od najnovijeg prema starom
  const sorted = [...(months||[])].sort((a,b)=> (b.month||"").localeCompare(a.month||""));

  for (const m of sorted){
    const div = document.createElement("div");
    div.className = "card month-card";
    const label = formatMonthLabel(m.month);
    const kitty = (m.kitty ?? 0).toFixed(2);
    const mp = m.matchesPlayed ?? (m.matches?.length || 0);
    const fr = m.fridays ?? 0;

    // top3 po bodovima (ako nije u JSON-u, izračunaj iz m.players ili iz m.matches)
    let monthPlayers = Array.isArray(m.players) ? m.players : computeMonthPlayersFromMatches(m.matches||[]);
    monthPlayers = monthPlayers.map(x => ({...x, points: x.points ?? (x.wins*3 + x.draws*1)}));

    const top3 = [...monthPlayers].sort((a,b)=>(b.points||0)-(a.points||0)).slice(0,3);

    div.innerHTML = `
      <div class="row">
        <div>
          <div class="title" style="margin:0">${label}</div>
          <div class="muted">Termini: ${mp}/${fr}</div>
        </div>
        <div class="big">${kitty} €</div>
      </div>
      <div style="margin-top:8px">
        ${top3.map(t=>`<span class="chip">${t.name} · ${t.points}b</span>`).join("")}
      </div>
      <div class="month-details"></div>
    `;

    div.addEventListener('click', ()=>{
      const box = div.querySelector('.month-details');
      const opened = box.style.display==="block";
      document.querySelectorAll('.month-details').forEach(el=>el.style.display="none");
      if (!opened){
        box.style.display = "block";
        renderMonthDetails(box, m, monthPlayers);
      }
    });

    host.appendChild(div);
  }
}

function renderMonthDetails(container, m, monthPlayers){
  // tablica igrača
  const tableHtml = `
    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>Igrač</th><th>W</th><th>D</th><th>L</th><th>Bodovi</th><th>Iznos (€)</th>
          </tr>
        </thead>
        <tbody>
          ${monthPlayers.map(p=>`
            <tr>
              <td>${p.name}</td>
              <td>${p.wins||0}</td>
              <td>${p.draws||0}</td>
              <td>${p.losses||0}</td>
              <td>${p.points||0}</td>
              <td>${(p.amount ?? (p.losses*3 + p.draws*2)).toFixed(2)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;

  // lista utakmica
  const matches = Array.isArray(m.matches) ? m.matches : [];
  const matHtml = `
    <div style="margin-top:14px">
      <div class="title" style="font-size:16px">Utakmice</div>
      ${matches.length===0 ? `<div class="muted">Nema utakmica za ovaj mjesec.</div>` : matches.map(mm=>`
        <div class="match">
          <div class="muted" style="width:90px">${mm.date||""}</div>
          <div class="team">Crni: ${escapeHtml((mm.black||[]).join(", "))}</div>
          <div class="score">${mm.score||""}</div>
          <div class="team">Bijeli: ${escapeHtml((mm.white||[]).join(", "))}</div>
          <div class="muted kicker">${mm.winner||""}</div>
        </div>
      `).join("")}
    </div>
  `;

  container.innerHTML = tableHtml + matHtml;
}

function computeMonthPlayersFromMatches(matches){
  const map = new Map();
  const add = (name, fld, inc=1)=>{
    if (!map.has(name)) map.set(name, {name, wins:0, draws:0, losses:0});
    map.get(name)[fld] += inc;
  };
  for (const m of (matches||[])){
    const w = (m.winner||"").toLowerCase();
    const black = m.black||[], white = m.white||[];
    if (w==="neriješeno"){
      black.forEach(n=>add(n,'draws'));
      white.forEach(n=>add(n,'draws'));
    } else if (w==="crni"){
      black.forEach(n=>add(n,'wins'));
      white.forEach(n=>add(n,'losses'));
    } else if (w==="bijeli"){
      white.forEach(n=>add(n,'wins'));
      black.forEach(n=>add(n,'losses'));
    }
  }
  const arr = [...map.values()].map(x=>({
    ...x,
    points: x.wins*3 + x.draws*1,
    amount: x.losses*3 + x.draws*2
  }));
  // popuni i one koji nisu igrali? (nemamo roster liste svih igrača u JSON-u po mjesecu – preskačemo)
  return arr;
}

function formatMonthLabel(ym){
  if (!ym) return "-";
  const [y,m] = ym.split("-");
  const im = parseInt(m,10);
  const hr = ["siječanj","veljača","ožujak","travanj","svibanj","lipanj","srpanj","kolovoz","rujan","listopad","studeni","prosinac"];
  return (hr[im-1]||ym) + " " + y;
}

function escapeHtml(s){
  return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

// modal
function showPlayer(nameEnc){
  const name = decodeURIComponent(nameEnc);
  const modal = document.getElementById('playerModal');
  document.getElementById('playerName').textContent = name;

  // detalji iz tablice
  const row = [...document.querySelectorAll("#tbl tbody tr")]
      .find(tr => tr.cells[0].innerText.trim() === name);
  if (row){
    const stats = `
      <div class="row"><div>Utakmice</div><div class="pill">${row.cells[1].innerText}</div></div>
      <div class="row"><div>W / D / L</div><div class="pill">${row.cells[2].innerText} / ${row.cells[3].innerText} / ${row.cells[4].innerText}</div></div>
      <div class="row"><div>Bodovi</div><div class="pill">${row.cells[5].innerText}</div></div>
      <div class="row"><div>Dolaznost</div><div class="pill">${row.cells[6].innerText}</div></div>
      <div class="row"><div>Uplata (€)</div><div class="pill">${row.cells[8].innerText}</div></div>
      <div style="margin-top:8px">Forma: ${row.cells[7].innerHTML}</div>
    `;
    document.getElementById('playerSub').textContent = "Pregled statistike";
    document.getElementById('playerStats').innerHTML = stats;
  } else {
    document.getElementById('playerSub').textContent = "";
    document.getElementById('playerStats').innerHTML = "<div class='muted'>Nema podataka.</div>";
  }

  modal.style.display = "flex";
}
function hideModal(){ document.getElementById('playerModal').style.display = "none"; }

loadData().catch(err=>{
  console.error(err);
  document.getElementById('kitty').textContent = "—";
});
</script>
</body>
</html>
