<!doctype html>
<html lang="hr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nogomet HNB Savica</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0f1720; --panel:#121a24; --muted:#8aa0b2; --text:#e6eef6; --accent:#3dd6ff;
  --win:#22c55e; --draw:#eab308; --loss:#ef4444; --card:#101823; --chip:#1b2633;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui}
.container{max-width:1200px;margin:0 auto;padding:24px}
.header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
.logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#38bdf8,#0ea5e9)}
h1{font-size:20px;margin:0}
.small{font-size:12px;color:#89a1b4}
.grid{display:grid;gap:16px}
@media(min-width:900px){
  .grid-cols-3{grid-template-columns:repeat(3,1fr)}
  .grid-cols-2{grid-template-columns:repeat(2,1fr)}
}
.card{background:var(--panel);border:1px solid #1e2a38;border-radius:14px;padding:16px}
.card h2{font-size:16px;margin:0 0 12px;color:#cce1f1}
.kpis{display:grid;gap:12px}
.kpi{background:var(--card);border:1px solid #1e2a38;border-radius:14px;padding:14px}
.kpi .title{color:var(--muted);font-size:12px;margin-bottom:6px}
.kpi .value{font-weight:700;font-size:24px}
.kpi.clickable{cursor:pointer}
.badge{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:#cfe4f3;border:1px solid #223141;border-radius:999px;padding:4px 10px;font-size:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px 8px;border-bottom:1px solid #1f2a36;font-size:14px}
.table th{color:#9fb4c6;text-align:left;font-weight:600}
.table td.clickable{cursor:pointer;color:#38bdf8}
.table td.clickable:hover{text-decoration:underline}
.form-strip{display:flex;gap:6px}
.form-dot{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#0b1220}
.form-dot.win{background:var(--win)}
.form-dot.draw{background:var(--draw)}
.form-dot.loss{background:var(--loss)}
.list{display:flex;flex-direction:column;gap:10px}
ul.clean{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
.pill{background:var(--card);border:1px solid #1e2a38;border-radius:12px;padding:10px}

/* MODALS */
.modal-bg{
  position:fixed;left:0;top:0;width:100%;height:100%;
  background:rgba(0,0,0,0.65);display:none;
  align-items:center;justify-content:center;z-index:50;
}
.modal{
  background:var(--panel);border-radius:14px;
  width:90%;max-width:820px;max-height:80vh;overflow-y:auto;
  padding:20px;border:1px solid #1e2a38;
}
.modal h3{margin:0 0 12px 0}
.close-btn{ float:right;color:#aaa;cursor:pointer;font-size:20px; }
.close-btn:hover{color:#fff}
.match-row{
  padding:10px 0;border-bottom:1px solid #1f2a36;font-size:14px;
  display:flex;flex-wrap:wrap;gap:8px;align-items:center;
}
.result-chip{ padding:3px 7px;border-radius:6px;font-size:12px;color:#0b1220; }
.result-chip.W{background:var(--win)}
.result-chip.D{background:var(--draw)}
.result-chip.L{background:var(--loss)}
.player-green{font-weight:700;color:#22c55e}
.mono{font-variant-numeric:tabular-nums}
/* Vanjski igrači (neutralno sivo) */
.external{color:#9aa7b5}
</style>

</head>
<body>

<div class="container">

  <div class="header">
    <div class="logo"></div>
    <div>
      <h1>Nogomet HNB Savica</h1>
      <div class="small" id="updated"></div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid grid-cols-3 kpis">
    <div class="kpi">
      <div class="title">Ukupno u blagajni</div>
      <div class="value" id="kpi-kitty">0.00 €</div>
      <div class="small" id="season"></div>
    </div>
    <div class="kpi">
      <div class="title">Termini (kumulativ)</div>
      <div class="value" id="kpi-terms">0/0</div>
      <div class="small">Odigrano / mogućih petaka</div>
    </div>
    <div class="kpi">
      <div class="title">Ishod (sezona)</div>
      <div id="kpi-outcomes" class="list"></div>
    </div>
  </div>

  <!-- Grafovi -->
  <div class="grid grid-cols-2" style="margin-top:16px">
    <div class="card">
      <h2>Dolaznost po igračima (Top 10)</h2>
      <canvas id="chartAttendance" height="120"></canvas>
    </div>
    <div class="card">
      <h2>Pobjede / Porazi (Top 10)</h2>
      <canvas id="chartWL" height="120"></canvas>
    </div>
  </div>

  <!-- Forma + Duo -->
  <div class="grid grid-cols-2" style="margin-top:16px">
    <div class="card">
      <h2>Najbolja forma — Top 5</h2>
      <div id="topForm" class="list"></div>
    </div>
    <div class="card">
      <h2>Duo — Top 3</h2>
      <div class="grid grid-cols-2">
        <div>
          <h3 style="margin:0 0 8px">Najbolji</h3>
          <ul id="duoBest" class="clean"></ul>
        </div>
        <div>
          <h3 style="margin:0 0 8px">Najlošiji</h3>
          <ul id="duoWorst" class="clean"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Streakovi -->
  <div class="card" style="margin-top:16px">
    <h2>Streakovi — Top 5</h2>
    <div class="grid grid-cols-2">
      <div>
        <h3 style="margin:0 0 8px">W-streak</h3>
        <div id="ws" class="list"></div>
      </div>
      <div>
        <h3 style="margin:0 0 8px">L-streak</h3>
        <div id="ls" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Master tablica -->
  <div class="card" style="margin-top:16px">
    <h2>Master tablica</h2>
    <table class="table" id="tblPlayers">
      <thead>
        <tr>
          <th>Igrač</th><th>Utakmice</th><th>W</th><th>D</th><th>L</th><th>Bodovi</th><th>Dolaznost</th><th>Uplate (€)</th><th>Forma</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Zadnjih 5 termina -->
  <div class="card" style="margin-top:16px">
    <h2>Zadnjih 5 termina</h2>
    <div id="last5" class="list"></div>
  </div>

  <!-- Mjesečni obračuni -->
  <div class="card" style="margin-top:16px">
    <h2>Mjesečni obračuni</h2>
    <div id="months" class="list"></div>
  </div>
</div>

<!-- MODAL: Player -->
<div id="playerModal" class="modal-bg">
  <div class="modal">
    <span class="close-btn" onclick="closeModal('playerModal')">✖</span>
    <h3 id="modalTitle"></h3>
    <div id="modalMatches"></div>
  </div>
</div>

<!-- MODAL: Month -->
<div id="monthModal" class="modal-bg">
  <div class="modal">
    <span class="close-btn" onclick="closeModal('monthModal')">✖</span>
    <h3 id="monthTitle"></h3>
    <table class="table">
      <thead>
        <tr>
          <th>Igrač</th><th>W</th><th>D</th><th>L</th><th>Bodovi</th><th>Uplata (€)</th>
        </tr>
      </thead>
      <tbody id="monthTable"></tbody>
    </table>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyUkzguVds3DQcg1JozhXZ4Ib-1chXvQT5A5TX8qK5Dwz9Tg40Bz_CqpG3xQBH5AxdbJw/exec";
let DATA = null;

(async function init(){
  const res = await fetch(API);
  DATA = await res.json();

  // header
  document.getElementById('updated').textContent =
    "Ažurirano: " + new Date(DATA.generatedAt).toLocaleString("hr-HR");
  document.getElementById('season').textContent = DATA.season + ". godina";
  document.getElementById('kpi-kitty').textContent = euro(DATA.kitty);
  document.getElementById('kpi-terms').textContent =
    DATA.seasonTotals.matchesPlayed + "/" + DATA.seasonTotals.fridays;

  // sadržaj
  renderOutcomes(DATA.seasonTotals);
  renderAttendanceChart(DATA.players);
  renderWLChart(DATA.players);
  renderTopForm(DATA.players);
  renderStreaks(DATA.players);
  renderPlayersTable(DATA.players);
  renderMonths(DATA.months);
  renderDuos(DATA.matches);     // Duo iz exporta
  renderLast5(DATA.matches);    // Zadnjih 5 termina (s vanjskima)
})();

function euro(x){ return (Number(x)||0).toFixed(2) + " €"; }

function renderOutcomes(t){
  document.getElementById('kpi-outcomes').innerHTML = `
    <span class="badge">Crni pobjede: ${t.blackWins}</span>
    <span class="badge">Bijeli pobjede: ${t.whiteWins}</span>
    <span class="badge">Neriješeno: ${t.draws}</span>
  `;
}

/* Najbolja forma — bez bodova */
function renderTopForm(players){
  const scored = players.map(p=>{
    const score = p.form.reduce((acc,ch)=> acc+(ch==="W"?3:ch==="D"?1:0),0);
    return { name:p.name, score, form:p.form };
  });
  const top5 = scored.sort((a,b)=>b.score-a.score).slice(0,5);

  const wrap = document.getElementById("topForm");
  wrap.innerHTML = "";

  top5.forEach(p=>{
    const div = document.createElement("div");
    div.className="pill";
    div.innerHTML = `<strong>${p.name}</strong> &nbsp; ${renderForm(p.form)}`;
    wrap.appendChild(div);
  });
}

/* Streakovi */
function renderStreaks(players){
  function calcStreak(arr, type){
    let curr = 0;
    for (let i = arr.length - 1; i >= 0; i--){
      if (arr[i] === type) curr++;
      else break;
    }
    return curr;
  }

  const mapped = players.map(p=>({
    name:p.name,
    w: calcStreak(p.form,"W"),
    l: calcStreak(p.form,"L")
  }));

  const ws = mapped.filter(x=>x.w>0).sort((a,b)=>b.w-a.w).slice(0,5);
  const ls = mapped.filter(x=>x.l>0).sort((a,b)=>b.l-a.l).slice(0,5);

  const wWrap = document.getElementById("ws");
  const lWrap = document.getElementById("ls");

  wWrap.innerHTML="";
  ws.forEach(p=>{
    const div=document.createElement("div");
    div.className="badge";
    div.innerHTML = `✅ W-streak: ${p.w} — ${p.name}`;
    wWrap.appendChild(div);
  });

  lWrap.innerHTML="";
  ls.forEach(p=>{
    const div=document.createElement("div");
    div.className="badge";
    div.innerHTML = `❌ L-streak: ${p.l} — ${p.name}`;
    lWrap.appendChild(div);
  });
}

/* Forme u boji */
function renderForm(list){
  return `<span class="form-strip">` +
    list.map(ch=>{
      const cls = ch==="W"?"win":(ch==="D"?"draw":"loss");
      return `<span class="form-dot ${cls}">${ch}</span>`;
    }).join("") +
    `</span>`;
}

/* Master */
function renderPlayersTable(players){
  const tb=document.querySelector("#tblPlayers tbody");
  tb.innerHTML="";
  players.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="clickable" onclick="openPlayerModal('${p.name.replace(/'/g,"\\'")}')">${p.name}</td>
      <td>${p.played}</td>
      <td>${p.wins}</td>
      <td>${p.draws}</td>
      <td>${p.losses}</td>
      <td>${p.points}</td>
      <td>${p.attendancePct.toFixed(1)}%</td>
      <td>${euro(p.amountTotal)}</td>
      <td>${renderForm(p.form)}</td>
    `;
    tb.appendChild(tr);
  });
}

/* Helperi za interne/vanjske */
const internalSet = new Set();
function isInternal(name){
  if (internalSet.size===0 && DATA && Array.isArray(DATA.players)) {
    DATA.players.forEach(p=>internalSet.add(p.name));
  }
  return internalSet.has(name);
}
function decorateName(name, highlight){
  if (name === highlight) return `<span class="player-green">${name}</span>`;
  if (!isInternal(name))   return `<span class="external">${name}</span>`;
  return name;
}

/* Zadnjih 5 termina — s vanjskima (sivo) */
function renderLast5(matches){
  const wrap = document.getElementById("last5");
  wrap.innerHTML = "";
  const list = [...(matches||[])].slice(-5).reverse();
  if (!list.length){
    const d = document.createElement("div");
    d.className = "pill";
    d.textContent = "Nema odigranih termina.";
    wrap.appendChild(d);
    return;
  }
  list.forEach(m=>{
    const el = document.createElement("div");
    el.className = "pill";
    el.innerHTML = `
      <div><strong>${m.date}</strong> — Rezultat: <span class="mono">${m.score}</span> ${winnerBadge(m.winner)}</div>
      <div class="small" style="margin-top:6px">
        <span>Crni: ${m.black.map(n=>decorateName(n)).join(", ")}</span><br/>
        <span>Bijeli: ${m.white.map(n=>decorateName(n)).join(", ")}</span>
      </div>
    `;
    wrap.appendChild(el);
  });
}
function winnerBadge(w){
  if (w==="crni") return `<span class="badge">Pobijedili: Crni</span>`;
  if (w==="bijeli") return `<span class="badge">Pobijedili: Bijeli</span>`;
  return `<span class="badge">Neriješeno</span>`;
}

/* Mjesečni obračuni (klik) */
function renderMonths(months){
  const wrap=document.getElementById("months");
  wrap.innerHTML="";
  months.forEach(m=>{
    const div=document.createElement("div");
    div.className="kpi clickable";
    div.onclick = ()=> openMonthModal(m);
    div.innerHTML=`
      <div class="title">${m.month}</div>
      <div class="value">${m.matchesPlayed}/${m.fridays} termina</div>
      <div class="badge">U blagajni: ${euro(m.kitty)}</div>
      <div class="badge">Top 3: ${m.top3.map(x=>x.name+" ("+x.points+")").join(", ")}</div>
    `;
    wrap.appendChild(div);
  });
}

/* ==========================
      MODAL — klik na igrača
   ========================== */
function openPlayerModal(name){
  const all = Array.isArray(DATA.matches) ? DATA.matches : [];
  let matches = all.filter(m => (m.black || []).includes(name) || (m.white || []).includes(name));
  matches = matches.reverse().slice(0, 20);

  document.getElementById("modalTitle").textContent = `${name} — zadnjih ${matches.length} nastupa`;

  const box = document.getElementById("modalMatches");
  box.innerHTML = "";

  if (matches.length === 0){
    const empty = document.createElement("div");
    empty.className = "match-row";
    empty.textContent = "Nema zabilježenih nastupa.";
    box.appendChild(empty);
  } else {
    matches.forEach(m=>{
      let result = "D";
      const onBlack = m.black.includes(name);
      if (m.winner === "crni" && onBlack) result = "W";
      if (m.winner === "bijeli" && !onBlack) result = "W";
      if (m.winner === "crni" && !onBlack) result = "L";
      if (m.winner === "bijeli" && onBlack) result = "L";

      const row = document.createElement("div");
      row.className="match-row";
      row.innerHTML = `
        <span><strong>${m.date}</strong></span>
        <span>Rezultat: <span class="mono">${m.score}</span></span>
        <span class="result-chip ${result}">${result}</span>
        <div style="flex-basis:100%"></div>
        <div><strong>Ekipa Crni:</strong> ${m.black.map(p=>decorateName(p, name)).join(", ")}</div>
        <div style="flex-basis:100%"></div>
        <div><strong>Ekipa Bijeli:</strong> ${m.white.map(p=>decorateName(p, name)).join(", ")}</div>
      `;
      box.appendChild(row);
    });
  }

  document.getElementById("playerModal").style.display="flex";
}

function closeModal(id){
  document.getElementById(id).style.display="none";
}

/* ==========================
         MJESEČNI MODAL
   ========================== */
function openMonthModal(monthObj){
  document.getElementById("monthTitle").textContent = `${monthObj.month} — mjesečni obračun`;
  const tb = document.getElementById("monthTable");
  tb.innerHTML = "";

  const rows = Object.values(monthObj.table || {});
  rows.sort((a,b)=> (b.points||0) - (a.points||0)); // po bodovima

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name}</td>
      <td>${r.W}</td>
      <td>${r.D}</td>
      <td>${r.L}</td>
      <td>${r.points}</td>
      <td>${euro(r.amount)}</td>
    `;
    tb.appendChild(tr);
  });

  document.getElementById("monthModal").style.display="flex";
}

/* ==========================
            DUO
   ========================== */
function renderDuos(matches){
  const bestUL  = document.getElementById("duoBest");
  const worstUL = document.getElementById("duoWorst");
  bestUL.innerHTML = ""; worstUL.innerHTML = "";

  // parovi računamo SAMO među internim igračima
  const isInt = (n)=>isInternal(n);

  const pairs = {}; // key -> {a,b,w:0,l:0}
  const addPair = (a,b,field)=>{
    const [x,y] = [a,b].sort();
    const k = x+"|"+y;
    if (!pairs[k]) pairs[k] = {a:x,b:y,w:0,l:0};
    pairs[k][field] += 1;
  };

  (matches||[]).forEach(m=>{
    const makePairs = (team, winnerIsThisTeam)=> {
      // uzmi SAMO interne
      const t = (team||[]).filter(isInt);
      for(let i=0;i<t.length;i++){
        for(let j=i+1;j<t.length;j++){
          const a=t[i], b=t[j];
          if (winnerIsThisTeam) addPair(a,b,"w");
          else if (m.winner!=="neriješeno") addPair(a,b,"l");
        }
      }
    };
    makePairs(m.black, m.winner==="crni");
    makePairs(m.white, m.winner==="bijeli");
  });

  const arr = Object.values(pairs);
  const topBest  = [...arr].sort((a,b)=> b.w - a.w || a.l - b.l).slice(0,3);
  const topWorst = [...arr].sort((a,b)=> b.l - a.l || a.w - b.w).slice(0,3);

  const streakStr = (ch, n)=> Array.from({length:n}, ()=>ch).join("/");

  if (topBest.length===0) bestUL.innerHTML = "<li class='small'>Nema podataka.</li>";
  else topBest.forEach(p=>{
    const li = document.createElement("li");
    li.className = "pill";
    li.innerHTML = `<strong>${p.a}</strong> — <strong>${p.b}</strong> &nbsp; <span class="result-chip W">${streakStr("W", p.w)}</span>`;
    bestUL.appendChild(li);
  });

  if (topWorst.length===0) worstUL.innerHTML = "<li class='small'>Nema podataka.</li>";
  else topWorst.forEach(p=>{
    const li = document.createElement("li");
    li.className = "pill";
    li.innerHTML = `<strong>${p.a}</strong> — <strong>${p.b}</strong> &nbsp; <span class="result-chip L">${streakStr("L", p.l)}</span>`;
    worstUL.appendChild(li);
  });
}

/* ==========================
         CHARTS
   ========================== */
function renderAttendanceChart(players){
  const top = [...players].sort((a,b)=>b.attendancePct-a.attendancePct).slice(0,10);
  new Chart(document.getElementById("chartAttendance"),{
    type:"bar",
    data:{
      labels:top.map(x=>x.name),
      datasets:[{label:"Dolaznost %",data:top.map(x=>x.attendancePct)}]
    },
    options:{scales:{y:{beginAtZero:true,max:100}},plugins:{legend:{display:false}}}
  });
}

function renderWLChart(players){
  const top=[...players].sort((a,b)=>b.wins-a.wins).slice(0,10);
  new Chart(document.getElementById("chartWL"),{
    type:"bar",
    data:{
      labels:top.map(x=>x.name),
      datasets:[
        {label:"Pobjede",data:top.map(x=>x.wins)},
        {label:"Porazi",data:top.map(x=>x.losses)}
      ]
    }
  });
}
</script>

</body>
</html>
